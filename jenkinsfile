pipeline {
    agent any
    
    environment {
        MAVEN_HOME = '/usr/share/maven'
        GITHUB_CREDENTIALS = 'devops_github_token'
        GITHUB_CREDENTIALS2 = 'github_token'
        imageName = 'abdulrazakmca/my-react-app'
        imageTag = 'latest'
        DOCKER_CREDENTIALS = 'dockerhub_token'
        DOCKER_REGISTRY_URL = 'https://index.docker.io/v1'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/abdulrazakmca/my-react-app.git', branch: 'my-react-app', credentialsId: env.GITHUB_CREDENTIALS2
                echo "Checkout Completed"
            }
        } // end of Checkout
        
        stage('Build') {
            steps {
                script {
                    echo "Docker Build Started"
                    // Corrected docker.build syntax
                    def dockerImage = docker.build("${imageName}:${imageTag}",".")
                    echo "Docker Build End"
                }
            }
        } // end of Build
        
        stage('Push Images') {
            steps {
                script {    
        //        sh 'sudo usermod -aG docker jenkins'
	//sh 'docker push abdulrazakmca/my-react-app:latest'
//sh 'echo "$SUDO_PASSWORD" | sudo -S docker push abdulrazakmca/my-react-app:latest'

				   
                    // Using the Docker Registry
                    docker.withRegistry(DOCKER_REGISTRY_URL, DOCKER_CREDENTIALS) {
                        // Tag the image properly before pushing
                       //sh 'sudo docker push ${imageName}:${imageTag}'
                        docker.image("${imageName}:${imageTag}").push()  // Push the image to the registry
                    }
                    echo 'End of push Image in dockerhub'
                }
            }
        } // End of Push Images
        
        stage('Run') {
            steps {
                script {
                    // Make sure to run the correct image
                    sh 'docker run -d -p 7979:80 abdulrazak/my-react-app'
                }
            }
        } // end of Run
    }
}